<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/css/chatroom.css">
    <meta charset="UTF-8">
    <title>채팅방</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                console.log("Connected: " + frame);

                // 구독은 여기서!
                stompClient.subscribe('/topic/room', function(messageOutput) {
                    const msg = JSON.parse(messageOutput.body);
                    const div = document.createElement('div');
                    div.textContent = msg.sender + ": " + msg.content;
                    document.getElementById("chat-area").appendChild(div);
                });
            });
        }

        function loadChatHistory() {
            fetch('/chat/history')
                .then(response => response.json())
                .then(messages => {
                    messages.forEach(msg => {
                        showMessage(msg.sender + ": " + msg.content + " (" + msg.timestamp + ")");
                    });
                });
        }

        function sendMessage() {
            const username = document.getElementById("username").value;
            const content = document.getElementById("message").value;
            if (!content.trim()) return;

            const msg = {
                sender: username,
                content: content
            };

            stompClient.send("/app/chat", {}, JSON.stringify(msg)); // 서버로 전송
            document.getElementById("message").value = ""; // 입력창 비우기
        }

        function showMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.textContent = message.sender + ": " + message.content;
            chatBox.appendChild(div);
        }

        window.onload = connect;
    </script>
</head>
<body>
<h2>채팅방</h2>
<input type="hidden" id="username" th:value="${username}"/>

<div id="chat-area" style="border: 1px solid black; height: 300px; overflow-y: scroll; margin-bottom: 10px;">
    <!-- 이전 메시지 출력 -->
    <div th:each="msg : ${messages}">
        <span th:text="${msg.sender} + ': ' + ${msg.content}"></span>
        <small th:text="${#temporals.format(msg.timestamp, 'HH:mm:ss')}"></small>
    </div>
</div>

<input type="text" id="message" placeholder="메시지 입력"/>
<button onclick="sendMessage()">보내기</button>

<br><br>
<form th:action="@{/logout}" method="post">
    <button type="submit">로그아웃</button>
</form>
</body>
</html>